# 17. Retrofit Android

Tài liệu này hướng dẫn Retrofit cho người mới bắt đầu dựa trên chính project hiện tại trong repo này (module `app`). Bạn có thể đối chiếu trực tiếp các ví dụ trong:

- `app/build.gradle.kts`
- `app/src/main/AndroidManifest.xml`
- `app/src/main/java/com/didan/android/retrofit/AlbumItem.kt`
- `app/src/main/java/com/didan/android/retrofit/Albums.kt`
- `app/src/main/java/com/didan/android/retrofit/AlbumService.kt`
- `app/src/main/java/com/didan/android/retrofit/RetrofitInstance.kt`
- `app/src/main/java/com/didan/android/retrofit/MainActivity.kt`

---

## Mục lục

1. [Retrofit Intro](#1-retrofit-intro)
2. [Retrofit Dependency](#2-retrofit-dependency)
3. [Adding Permissions](#3-adding-permissions)
4. [JSON Syntax](#4-json-syntax)
5. [POJO Data Class](#5-pojo-data-class)
6. [JSON Array](#6-json-array)
7. [API Service Interface](#7-api-service-interface)
8. [Retrofit Instance](#8-retrofit-instance)
9. [Implementing Retrofit](#9-implementing-retrofit)
10. [HTTP Requests & Responses](#10-http-requests--responses)
11. [Query Parameters](#11-query-parameters)
12. [Path Parameters](#12-path-parameters)
13. [Receiving JSON to Logcat](#13-receiving-json-to-logcat)
14. [Displaying JSON into TextView](#14-displaying-json-into-textview)

---

## 1. Retrofit Intro

**Retrofit** là một thư viện HTTP client dành cho Android (Square) giúp bạn gọi API REST đơn giản hơn bằng cách:

- Khai báo API bằng **interface** + **annotation** (`@GET`, `@POST`, `@Query`, `@Path`, …).
- Tự động chuyển đổi JSON ⇄ object Kotlin/Java thông qua **Converter** (Gson/Moshi/…).
- Kết hợp tốt với **Coroutines** (`suspend`) để viết bất đồng bộ gọn và rõ.

Trong project này, API ví dụ dùng `https://jsonplaceholder.typicode.com` (fake REST API).

---

## 2. Retrofit Dependency

### 2.1. Dependencies trong project hiện tại

Project đang dùng **Version Catalog** (`gradle/libs.versions.toml`) và khai báo ở `app/build.gradle.kts`:

```kts
// Retrofit
implementation(libs.retrofit)
// Converter Gson
implementation(libs.retrofit.converter.gson)
// Gson
implementation(libs.gson)

// Coroutine (bất đồng bộ)
implementation("org.jetbrains.kotlinx:kotlinx-coroutines-android:1.10.2")

// OkHttp Logging Interceptor (log request/response)
implementation("com.squareup.okhttp3:logging-interceptor:5.3.0")
```

> Gợi ý: nếu bạn không dùng Version Catalog, bạn có thể khai báo trực tiếp bằng chuỗi dependency trong `app/build.gradle(.kts)`.

### 2.2. Sync Gradle

Sau khi thêm dependency, bấm **Sync Now** (Android Studio) để Gradle tải thư viện.

---

## 3. Adding Permissions

Để gọi mạng, Android cần quyền **INTERNET** trong `AndroidManifest.xml`:

```xml
<uses-permission android:name="android.permission.INTERNET" />
```

Trong project này, bạn đã có sẵn:

- `android.permission.INTERNET`
- `android.permission.ACCESS_NETWORK_STATE`
- `android.permission.ACCESS_WIFI_STATE`

> Lưu ý: `ACCESS_NETWORK_STATE`/`ACCESS_WIFI_STATE` không bắt buộc để gọi Retrofit, nhưng hữu ích nếu bạn muốn kiểm tra trạng thái mạng.

---

## 4. JSON Syntax

Retrofit thường làm việc với dữ liệu JSON từ server.

### 4.1. JSON Object (đối tượng)

Ví dụ 1 album dạng object:

```json
{
  "userId": 1,
  "id": 1,
  "title": "quidem molestiae enim"
}
```

- **Key** luôn là chuỗi (có dấu ngoặc kép).
- **Value** có thể là number, string, boolean, null, object, array.

### 4.2. JSON Array (mảng)

Ví dụ danh sách album dạng array:

```json
[
  { "userId": 1, "id": 1, "title": "..." },
  { "userId": 1, "id": 2, "title": "..." }
]
```

---

## 5. POJO Data Class

“POJO” (Plain Old Java Object) là cách gọi chung cho class chỉ chứa dữ liệu. Với Kotlin, ta thường dùng **data class**.

### 5.1. Model `AlbumItem`

Trong project, bạn có:

```kotlin
data class AlbumItem(
    @SerializedName("userId") val userId: Int,
    @SerializedName("id") val id: Int,
    @SerializedName("title") val title: String
)
```

Giải thích:

- `@SerializedName("userId")` dùng khi tên field JSON và tên thuộc tính Kotlin **khác nhau** hoặc để “chắc ăn”.
- Nếu JSON key trùng tên thuộc tính, bạn có thể bỏ `@SerializedName` (Gson vẫn map được).

### 5.2. Nullable & default value (khuyến nghị)

API thực tế có thể trả thiếu field hoặc null. Để app ít crash hơn:

```kotlin
data class AlbumItem(
    @SerializedName("userId") val userId: Int? = null,
    @SerializedName("id") val id: Int? = null,
    @SerializedName("title") val title: String? = null
)
```

---

## 6. JSON Array

Khi API trả về **mảng JSON**, Retrofit có thể map trực tiếp sang:

- `List<AlbumItem>`
- hoặc một type kế thừa `ArrayList<AlbumItem>` (như project này)

Project đang dùng:

```kotlin
class Albums : ArrayList<AlbumItem>()
```

Điều này giúp type trả về gọn: `Response<Albums>` thay vì `Response<List<AlbumItem>>`.

---

## 7. API Service Interface

Retrofit yêu cầu bạn khai báo các endpoint trong một **interface**. Project có `AlbumService`:

```kotlin
interface AlbumService {
    @GET("/albums")
    suspend fun getAlbums(): Response<Albums>

    @GET("/albums")
    suspend fun getSpecificAlbums(@Query("userId") userId: Int): Response<Albums>
}
```

Giải thích nhanh:

- `@GET` là HTTP GET.
- `suspend` để gọi trong coroutine (không block UI).
- `Response<Albums>` chứa cả **status code, headers, body, errorBody**.
- `@Query("userId")` tạo URL dạng `.../albums?userId=6`.

> Khuyến nghị: thường viết `@GET("albums")` (không có dấu `/`) để tránh nhầm lẫn khi ghép với `baseUrl`.

---

## 8. Retrofit Instance

Bạn cần một nơi cấu hình Retrofit (baseUrl + converter + (tuỳ chọn) OkHttpClient).

### 8.1. Cấu hình cơ bản (như project)

```kotlin
Retrofit.Builder()
    .baseUrl(BASE_URL)
    .addConverterFactory(
        GsonConverterFactory.create(GsonBuilder().create())
    )
    .build()
```

> Lưu ý quan trọng: `baseUrl` của Retrofit **thường phải kết thúc bằng dấu `/`** (ví dụ: `https://jsonplaceholder.typicode.com/`). Nếu thiếu `/`, Retrofit có thể báo lỗi khi build.

### 8.2. Nâng cao: bật log request/response bằng OkHttp Logging Interceptor

<a id="retrofit-log-interceptor"></a>

Project đã có dependency `logging-interceptor`, bạn có thể gắn vào Retrofit như sau:

```kotlin
val interceptor = HttpLoggingInterceptor().apply {
    level = HttpLoggingInterceptor.Level.BODY
}

val okHttpClient = OkHttpClient.Builder()
    .addInterceptor(interceptor)
    .build()

val retrofit = Retrofit.Builder()
    .baseUrl(BASE_URL)
    .client(okHttpClient)
    .addConverterFactory(GsonConverterFactory.create())
    .build()
```

Khi bật, Logcat sẽ hiển thị URL, headers và body (hữu ích lúc debug).

---

## 9. Implementing Retrofit

Một luồng triển khai Retrofit “chuẩn” cho người mới:

1. **Chuẩn bị API** (base URL + endpoint).
2. **Tạo model** (POJO/data class) map JSON.
3. **Tạo service interface** chứa endpoint.
4. **Tạo Retrofit instance** (singleton).
5. **Gọi API** từ UI layer (Activity/Fragment) hoặc tốt hơn là từ ViewModel/Repository.
6. **Hiển thị dữ liệu** lên UI.

Trong project hiện tại:

- Model: `AlbumItem`, `Albums`
- Service: `AlbumService`
- Instance: `RetrofitInstance`
- Call API + hiển thị: `MainActivity`

---

## 10. HTTP Requests & Responses

### 10.1. Các HTTP method phổ biến

- `@GET` lấy dữ liệu
- `@POST` tạo mới
- `@PUT` cập nhật toàn bộ
- `@PATCH` cập nhật một phần
- `@DELETE` xoá

Ví dụ (minh hoạ):

```kotlin
@GET("albums/{id}")
suspend fun getAlbumDetail(@Path("id") id: Int): Response<AlbumItem>
```

### 10.2. Đọc `Response` đúng cách

Khi nhận `Response<T>`, hãy kiểm tra:

- `response.isSuccessful`
- `response.code()` (200, 201, 400, 401, 404, 500, …)
- `response.body()` (thành công)
- `response.errorBody()` (thất bại)

Ví dụ:

```kotlin
val response = retrofitService.getSpecificAlbums(6)
if (response.isSuccessful) {
    val data = response.body()
} else {
    val error = response.errorBody()?.string()
}
```

### 10.3. Bắt lỗi mạng (khuyến nghị)

Khi gọi mạng có thể lỗi (mất mạng, timeout…). Nên bọc `try/catch`:

```kotlin
try {
    val response = retrofitService.getAlbums()
} catch (e: Exception) {
    // IOException/HttpException tuỳ trường hợp
}
```

---

## 11. Query Parameters

Query parameter là phần `?key=value` trên URL.

### 11.1. `@Query`

Trong project:

```kotlin
@GET("/albums")
suspend fun getSpecificAlbums(@Query("userId") userId: Int): Response<Albums>
```

URL tạo ra: `.../albums?userId=6`

### 11.2. `@QueryMap` (nâng cao)

Khi có nhiều query:

```kotlin
@GET("albums")
suspend fun getAlbumsByFilters(
    @QueryMap filters: Map<String, String>
): Response<Albums>
```

Gọi:

```kotlin
val filters = mapOf("userId" to "6", "_sort" to "id", "_order" to "desc")
```

---

## 12. Path Parameters

Path parameter là phần nằm trong đường dẫn URL, ví dụ: `/albums/10`.

Khai báo bằng `@Path`:

```kotlin
@GET("albums/{id}")
suspend fun getAlbumDetail(@Path("id") id: Int): Response<AlbumItem>
```

Gọi:

```kotlin
val response = retrofitService.getAlbumDetail(10)
```

---

## 13. Receiving JSON to Logcat

Có 2 cách phổ biến để “nhìn thấy” dữ liệu trả về:

### 13.1. Log bằng code (dễ hiểu cho người mới)

```kotlin
val response = retrofitService.getSpecificAlbums(6)
if (response.isSuccessful) {
    val albums = response.body()
    Log.d("API", "albums = $albums")
} else {
    Log.e("API", "error = ${response.code()}")
}
```

> Nếu muốn log ra JSON “đẹp” hơn, bạn có thể dùng Gson: `Gson().toJson(albums)`.

### 13.2. Log tự động bằng OkHttp Logging Interceptor (khuyến nghị khi debug)

Chỉ cần cấu hình interceptor ở `RetrofitInstance` như phần [8.2](#retrofit-log-interceptor), Logcat sẽ có đầy đủ request/response.

---

## 14. Displaying JSON into TextView

Trong project, `MainActivity` đang:

- Gọi API bằng Retrofit
- Lặp qua danh sách album
- Append title vào `TextView`

Ví dụ tương tự:

```kotlin
val albumsList = response.body()?.listIterator()
if (albumsList != null) {
    while (albumsList.hasNext()) {
        val albumItem = albumsList.next()
        textView.append("Album Title: ${albumItem.title}\n")
    }
}
```

Gợi ý khi dữ liệu nhiều:

- Dùng `RecyclerView` + Adapter để hiển thị danh sách thay vì `TextView.append`.
- Gọi API trong `ViewModel` và quan sát bằng `LiveData/StateFlow` để code sạch hơn (đặc biệt khi app lớn).
