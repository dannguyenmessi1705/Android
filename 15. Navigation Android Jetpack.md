# Navigation trong Android Jetpack (Kotlin)

## 1. Giới thiệu Navigation Component
Navigation Component là bộ công cụ giúp bạn điều hướng giữa các màn hình (thường là Fragment) trong ứng dụng Android. Thay vì tự viết `FragmentTransaction` và quản lý back stack thủ công, bạn cấu hình bằng một sơ đồ điều hướng (NavGraph) rõ ràng.

Lợi ích chính:
- Đỡ viết code điều hướng lặp lại.
- Dễ hình dung luồng màn hình.
- Hỗ trợ truyền dữ liệu an toàn giữa các Fragment.

Ba thành phần chính:
- **NavController**: “bộ điều khiển” để thực hiện điều hướng.
- **NavHostFragment**: nơi hiển thị các Fragment theo NavGraph.
- **NavGraph**: sơ đồ điều hướng, định nghĩa các màn hình và action.

## 2. Project Setup
Giả sử bạn đã tạo project Android Studio (Empty Activity) với Kotlin.

Thêm các dependency cần thiết trong `build.gradle` (module):

```gradle
// Navigation Component
implementation "androidx.navigation:navigation-fragment-ktx:2.7.7"
implementation "androidx.navigation:navigation-ui-ktx:2.7.7"
```

Giải thích nhanh:
- `navigation-fragment-ktx`: hỗ trợ Navigation khi dùng Fragment.
- `navigation-ui-ktx`: tích hợp với UI (Toolbar, Bottom Navigation, …).

Sync Gradle để tải thư viện.

## 3. Navigation Graph
NavGraph là sơ đồ điều hướng, chứa các màn hình (destination) và action chuyển màn hình.

Tạo file `res/navigation/nav_graph.xml`:

```xml
<?xml version="1.0" encoding="utf-8"?>
<navigation xmlns:android="http://schemas.android.com/apk/res/android"
    xmlns:app="http://schemas.android.com/apk/res-auto"
    android:id="@+id/nav_graph"
    app:startDestination="@id/homeFragment">

    <fragment
        android:id="@+id/homeFragment"
        android:name="com.example.app.HomeFragment"
        android:label="Home" />

    <fragment
        android:id="@+id/secondFragment"
        android:name="com.example.app.SecondFragment"
        android:label="Second" />

</navigation>
```

- `startDestination` là màn hình đầu tiên khi app mở.
- Mỗi `<fragment>` là một destination.

## 4. NavHostFragment
NavHostFragment là “khung” chứa các Fragment theo NavGraph.

Khai báo trong `activity_main.xml`:

```xml
<androidx.fragment.app.FragmentContainerView
    android:id="@+id/nav_host"
    android:name="androidx.navigation.fragment.NavHostFragment"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    app:navGraph="@navigation/nav_graph"
    app:defaultNavHost="true" />
```

- `app:navGraph` liên kết NavHostFragment với NavGraph.
- `app:defaultNavHost="true"` giúp xử lý nút Back tự động.

## 5. HomeFragment
Tạo `HomeFragment` với layout đơn giản.

`fragment_home.xml`:

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:gravity="center"
    android:padding="24dp">

    <TextView
        android:id="@+id/tvTitle"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Home Screen"
        android:textSize="20sp" />

    <Button
        android:id="@+id/btnGo"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:layout_marginTop="16dp"
        android:text="Go to Second" />

</LinearLayout>
```

`HomeFragment.kt`:

```kotlin
class HomeFragment : Fragment(R.layout.fragment_home) {
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        val btnGo = view.findViewById<Button>(R.id.btnGo)
        btnGo.setOnClickListener {
            // Điều hướng sẽ được thêm ở phần 7
        }
    }
}
```

Mục đích: đây là màn hình bắt đầu, cho người dùng bấm nút để sang màn hình khác.

## 6. SecondFragment
Tạo `SecondFragment` để hiển thị dữ liệu nhận được.

`fragment_second.xml`:

```xml
<LinearLayout xmlns:android="http://schemas.android.com/apk/res/android"
    android:layout_width="match_parent"
    android:layout_height="match_parent"
    android:orientation="vertical"
    android:gravity="center"
    android:padding="24dp">

    <TextView
        android:id="@+id/tvMessage"
        android:layout_width="wrap_content"
        android:layout_height="wrap_content"
        android:text="Second Screen"
        android:textSize="20sp" />

</LinearLayout>
```

`SecondFragment.kt`:

```kotlin
class SecondFragment : Fragment(R.layout.fragment_second) {
    override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
        super.onViewCreated(view, savedInstanceState)
        // Nhận dữ liệu ở phần 8
    }
}
```

Hai Fragment này là hai màn hình trong luồng điều hướng đơn giản.

## 7. Navigation Action
Action là “đường đi” giữa các destination trong NavGraph.

Thêm action vào `nav_graph.xml`:

```xml
<fragment
    android:id="@+id/homeFragment"
    android:name="com.example.app.HomeFragment"
    android:label="Home">

    <action
        android:id="@+id/action_home_to_second"
        app:destination="@id/secondFragment" />
</fragment>
```

Điều hướng trong `HomeFragment.kt`:

```kotlin
btnGo.setOnClickListener {
    findNavController().navigate(R.id.action_home_to_second)
}
```

Khi bấm nút, app sẽ chuyển từ HomeFragment sang SecondFragment.

## 8. Passing Data Between Destinations
### Khái niệm Safe Args
Safe Args giúp truyền dữ liệu giữa các Fragment một cách an toàn về kiểu dữ liệu.

### Use Safe Args to pass data with safe type
Nói đơn giản, Safe Args sẽ sinh ra các lớp Kotlin để bạn truyền và nhận dữ liệu đúng kiểu. Nhờ đó bạn tránh lỗi kiểu dữ liệu khi dùng `Bundle` thủ công.

Ví dụ bạn khai báo một argument kiểu `string` trong NavGraph, thì lớp sinh ra sẽ buộc bạn truyền đúng `String`, và khi nhận lại cũng là `String` rõ ràng.

### Truyền dữ liệu bằng Bundle (cách thủ công)
Cách này nhanh và đơn giản, nhưng bạn phải tự quản lý key và kiểu dữ liệu.

Gửi dữ liệu từ `HomeFragment`:

```kotlin
btnGo.setOnClickListener {
    val bundle = bundleOf("message" to "Hello from Home")
    findNavController().navigate(R.id.action_home_to_second, bundle)
}
```

Bạn cần import `androidx.core.os.bundleOf` (thường đã có trong `core-ktx`).

Nhận dữ liệu trong `SecondFragment`:

```kotlin
override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
    super.onViewCreated(view, savedInstanceState)
    val message = arguments?.getString("message") ?: "No message"
    view.findViewById<TextView>(R.id.tvMessage).text = message
}
```

Nhược điểm: nếu bạn gõ sai key hoặc lấy sai kiểu (ví dụ `getInt` thay vì `getString`) thì dễ gây lỗi khi chạy.

### Ghi chú về Parcelable khi truyền object
Nếu bạn muốn truyền **object tùy chỉnh** giữa các Fragment/View, bạn nên dùng `Parcelable` (nhanh hơn `Serializable`). Navigation + Safe Args cũng hỗ trợ kiểu `Parcelable`, nhưng đối tượng phải triển khai `Parcelable`.

Ví dụ với Kotlin:

```kotlin
@Parcelize
data class User(val id: Int, val name: String) : Parcelable
```

Khi đó bạn có thể truyền `User` qua `Bundle` hoặc khai báo `app:argType="com.example.app.User"` trong NavGraph để Safe Args sinh class hỗ trợ.

Lưu ý: dữ liệu trong `Bundle` có giới hạn kích thước, tránh truyền object quá lớn (ví dụ danh sách dài hoặc ảnh bitmap).

### Bật Safe Args
Trong `build.gradle` (project), thêm plugin:

```gradle
classpath "androidx.navigation:navigation-safe-args-gradle-plugin:2.7.7"
```

Trong `build.gradle` (module), áp dụng plugin:

```gradle
plugins {
    id "androidx.navigation.safeargs.kotlin"
}
```

Sync Gradle.

### Truyền dữ liệu
Khai báo argument trong NavGraph:

```xml
<fragment
    android:id="@+id/secondFragment"
    android:name="com.example.app.SecondFragment"
    android:label="Second">

    <argument
        android:name="message"
        app:argType="string" />
</fragment>
```

Điều hướng có dữ liệu trong `HomeFragment.kt`:

```kotlin
btnGo.setOnClickListener {
    val action = HomeFragmentDirections.actionHomeToSecond("Hello from Home")
    findNavController().navigate(action)
}
```

Nhận dữ liệu trong `SecondFragment.kt`:

```kotlin
override fun onViewCreated(view: View, savedInstanceState: Bundle?) {
    super.onViewCreated(view, savedInstanceState)
    val args = SecondFragmentArgs.fromBundle(requireArguments())
    val message = args.message
    view.findViewById<TextView>(R.id.tvMessage).text = message
}
```

## 9. Tổng kết
Luồng điều hướng cơ bản:
- App mở `HomeFragment` (startDestination).
- Bấm nút → dùng `NavController` chuyển sang `SecondFragment`.
- Dữ liệu được truyền qua Safe Args.

Những lỗi thường gặp với người mới:
- Quên đặt `app:navGraph` trong `NavHostFragment`.
- Sai tên package trong `android:name` của fragment.
- Quên sync Gradle sau khi bật Safe Args.

Gợi ý mở rộng:
- **BackStack**: hiểu cách hệ thống lưu lại màn hình trước đó.
- **Up Button**: hiển thị nút quay lại trên Toolbar.
- **Bottom Navigation**: điều hướng giữa các tab.

### Sơ đồ luồng điều hướng (text)
Dưới đây là sơ đồ chi tiết hơn để bạn hình dung dòng chảy điều hướng và dữ liệu:

```
MainActivity
  └── NavHostFragment (nav_graph)
        ├── HomeFragment (startDestination)
        │     └── Button click
        │           └── NavController.navigate(action_home_to_second, message)
        └── SecondFragment
              └── Hiển thị message trong TextView
```

Bạn có thể thử thêm một Fragment thứ ba để luyện tập, sau đó bổ sung action mới trong NavGraph để mở rộng sơ đồ. Với cấu trúc này, bạn đã nắm được cách dùng Jetpack Navigation cho một app đơn giản.
